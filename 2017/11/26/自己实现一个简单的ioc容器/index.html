<!DOCTYPE html><html lang="" class="loading"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>追梦</title><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="google" content="notranslate"><meta name="keywords" content="yidreamc,"><meta name="author" content="yidreamc"><link rel="alternative" href="atom.xml" title="追梦" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><link rel="stylesheet" href="/css/diaspora.css"><link href="/plugins/hljs/atom-one-dark.css" rel="stylesheet"><link rel="stylesheet" href="/styles/css/main.css"></head><body class="loading"><div id="loader"></div><div id="single"><div id="top" style="display:block"><div class="bar" style="width:0"></div><a class="icon-home image-icon" href="javascript:;"></a><h3 class="subtitle">自己实现一个简单的ioc容器</h3><div class="social"></div><div class="scrollbar"></div></div><div class="section"><div class="article"><div class="main"><h1 id="title" class="title">自己实现一个简单的ioc容器</h1><div class="stuff"> <span>十一月 26, 2017</span><ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/java/">java</a></li></ul></div><div class="content markdown"><p>某节实验课的任务是练习使用spring的ioc，因为之前用过，感觉也没啥意思，就想了以下他的实现原理，然后自己使用java反射机制实现了一个简单的ioc容器。以下对原理进行简单的说明，完整的代码及用法详见<a href="https://github.com/xmfaly/simpleioc" target="_blank" rel="noopener">xmfaly/simpleioc</a></p><p>首先定义@Autowired注解用于自动注入</p><pre><code>@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Autowired {

    Class&lt;?&gt; value() default Class.class;

    String name() default &quot;&quot;;
}
</code></pre><p>建立一个<code>Container</code>容器类<br>建立两个<code>map</code>分别保存类名和bean、对象名和类名的关系</p><pre><code>    // 保存所有bean 格式为 类名 : bean
    private Map&lt;String, Object&gt; beans;

    // 存储对象和类名的关系 对象名 ：bean
    private Map&lt;String, Object&gt; beanKeys;
</code></pre><p>这里为了安全起见，使用<code>ConcurrentHashMap()</code>实例化这两个<code>map</code></p><pre><code>    public Container(){
        beans = new ConcurrentHashMap&lt;String, Object&gt;();
        beanKeys = new ConcurrentHashMap&lt;String, String&gt;();
    }
</code></pre><p>向容器内注册bean，这里我重载了三种形式，当然也可以更多，关键看使用的场景了。</p><pre><code>  /**
     * 以class的形式注册
     */
    public Object registerBean(Class&lt;?&gt; cls) {
        String className = cls.getName();
        Object bean = null;

        try {
            bean = cls.newInstance();
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
        beans.put(className, bean);

        //不指定对象名的情况下类名和对象名相同
        beanKeys.put(className, bean);
        return bean;
    }

    /**
     * 以bean的形式注册
     */
    public Object registerBean(Object bean) {
        String className = bean.getClass().getName();
        beans.put(className, bean);
        beanKeys.put(className, bean);
        return bean;
    }


    /**
     * 以带对象名的class形式注册
     */
    public Object registerBean(String name, Class&lt;?&gt; cls) {
        String className = cls.getName();
        Object bean = null;

        try {
            bean = cls.newInstance();
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }

        beans.put(className, bean);
        beanKeys.put(name, bean);
        return bean;
    }

    /**
     * 注册一个带名称的Bean到容器中
     */
    public Object registerBean(String name, Object bean) {
        String className = bean.getClass().getName();
        beans.put(className, bean);
        beanKeys.put(name, bean);
        return bean;
    }

</code></pre><p>从容器中取出bean</p><pre><code>   /**
     * 通过 Class 对象获取bean
     */
    public &lt;T&gt; T getBean(Class&lt;?&gt; cls) {
        String className = cls.getName();
        Object object = beans.get(className);
        if (null != object) {
            return (T) object;
        }
        return null;
    }

    /**
     * 通过对象名获取 bean
     */
    public &lt;T&gt; T getBeanByName(String name) {
        Object object = beanKeys.get(name);;
        if (null != object) {
            return (T) object;
        }
        return null;
    }

</code></pre><p>在容器启动的时候遍历容器内的所有bean对bean进行注入</p><pre><code>  /**
     * 初始化
     */
    public void init() {
        Iterator&lt;Map.Entry&lt;String, Object&gt;&gt; it = beans.entrySet().iterator();
        while (it.hasNext()) {
            Map.Entry&lt;String, Object&gt; entry = it.next();
            Object object = entry.getValue();
            injection(object);
        }
    }
</code></pre><p>其中使用到的方法的实现</p><pre><code>     /**
     * 注入
     */
    public void injection(Object object) {
        Field[] fields = object.getClass().getDeclaredFields();
        try {

            //遍历所有属性寻找@Autowired注解
            for (Field field : fields) {
                Autowired autowired = field.getAnnotation(Autowired.class);
                if (null != autowired) {

                    // 要注入的字段
                    Object autoWritedField = null;
                    String name = autowired.name();

                    if (!name.equals(&quot;&quot;)) {
                        Object bean = beanKeys.get(name);
                        if (null != bean ) {
                            autoWritedField = bean;
                        }


                        if (null == autoWritedField) {
                            throw new RuntimeException(&quot;Unable to autoWrited &quot; + name);
                        }
                    } else {
                        if (autowired.value() == Class.class) {
                            //该属性的Type
                            autoWritedField = recursiveAssembly(field.getType());
                        } else {
                            // 指定装配的类
                            autoWritedField = this.getBean(autowired.value());
                            if (null == autoWritedField) {
                                autoWritedField = recursiveAssembly(autowired.value());
                            }
                        }
                    }

                    if (null == autoWritedField) {
                        throw new RuntimeException(&quot;Unable to autoWrited &quot; + field.getType().getCanonicalName());
                    }

                    boolean accessible = field.isAccessible();
                    field.setAccessible(true);
                    field.set(object, autoWritedField);
                    field.setAccessible(accessible);
                }
            }
        } catch (SecurityException e) {
            e.printStackTrace();
        } catch (IllegalArgumentException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
    }

    /**
     * 修复没有指定注解及默认注入的情况
     */
    private Object recursiveAssembly(Class&lt;?&gt; cls) {
        if (null != cls) {
            return this.registerBean(cls);
        }
        return null;
    }

</code></pre><p>写个测试测试3中注入类型</p><pre><code>public class TestIoc {

    class A{

        @Autowired(name = &quot;myvalue&quot;)
        private Integer value;

        @Autowired(name = &quot;str&quot;)
        private String myStr;

        @Autowired(value = String.class)
        private String myStr2;

        @Autowired
        public String myStr3;

        public void show(){
            System.out.println(&quot;value: &quot; + value);
            System.out.println(&quot;str: &quot; + myStr);
            System.out.println(myStr2 == null);
            System.out.println(myStr3 == null);
        }
    }

    @Test
    public void test(){
        Container c = new Container();
        c.registerBean(&quot;a&quot;,new A());
        c.registerBean(&quot;str&quot;,&quot;注入成功&quot;);
        c.registerBean(&quot;myvalue&quot;,2333);
        c.initWired();
        A a = c.getBeanByName(&quot;a&quot;);
        a.show();
    }
}
</code></pre><p>测试成功</p><pre><code>value: 2333
str: 注入成功
false
false
</code></pre><!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]--></div><div id="gitalk-container" class="comment link" data-ae="true" data-ci="b13f1c99b04e2cb032ba" data-cs="8b5cec5e81b3ab9ff1b533046e66f15650d0e98c" data-r="yidreamc.github.io" data-o="yidreamc" data-a="yidreamc" data-d="false">查看评论</div></div><div class="side"></div></div></div></div></body><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script><script src="/js/plugin.js"></script><script src="/js/diaspora.js"></script><link rel="stylesheet" href="/photoswipe/photoswipe.css"><link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css"><script src="/photoswipe/photoswipe.min.js"></script><script src="/photoswipe/photoswipe-ui-default.min.js"></script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script></html>