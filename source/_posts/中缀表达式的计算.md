---
title: '中缀表达式的计算'
date: 2018-08-31 17:59:52
tags:
cover: /img/cover/cover-6
---
常见的算式比如`2+3`、`4*5+2`这种都是中缀表达式，特点是运算符在操作数的中间，这种表达式对人来说还是比较有好的，但对于程序来说就不太有好了，因为运算符号包含了优先级，而且还有括号先计算这些规则。首先声明一下，这种表达式只是不太友好，并不是不能用程序直接做，只是相对于而言稍微困难一点。  
比较常见一点的做法就是转换成后缀表达式来进行计算，因为中缀表达式转换为后缀表达式很简单，而后缀表达式的计算比较符合程序的逻辑，比较好做。  

### 常规做法
中缀表达式转换为后缀表达式，然后计算后缀表达式  
中缀表达式转换为后缀表达式规则如下   
有一个符号栈，一个输出列
- 当遇到一个左括号时立即将其压栈
- 当遇到对应的右括号时，将栈中的操作符弹出并输出，直到遇到左括号。最后再弹出左括号，括号不输出
- 当遇到一个数时，直接输出
- 当遇到操作符，将他与栈顶操作符比较
    - 如果它比栈顶的操作符优先级高，或者它是左括号后的第一个操作符，则将其压入栈
    - 如果优先级低或相等，将栈顶元素弹出并输出

计算后缀表达式方法如下
1. 建立一个栈，顺序遍历上面的输出列
2. 遇到操作数压栈
3. 遇到操作符则弹出栈顶的两个数，并进行计算，并将结果压栈

[ts实现](https://github.com/yidreamc/ts-lib/tree/master/calc)


### 直接计算
直接计算也是可以的，计算规则如下  
构建两个栈，数栈（存放数和左括号）和操作符栈
1. 如果是数字，
    1. 操作符栈为空，或栈顶为加或减，则压入数栈
    2. 操作符栈为乘除，则加入数栈，判断数栈中倒数第2个元素是否为数字，
        1. 若是，则进行计算，并将结果加入到数栈中
        2. 若不是数字（而是左括号）则继续后续遍历
2. 如果是操作符，入操作符栈
3. 如果是左边括号，入数栈
4. 如果是右边括号：查找左括号在数栈中的位置，表达式中左括号后面首个操作符在操作栈中的位置，计算括号内部结果，用结果代替左括号的位置，然后判断前面的操作符是否为乘除，若是，则继续计算
5. 最后剩下加减表达式，这时再来一次加减计算：从左到右遍历计算

`1 + 2 * ( 3 + 4 * 5 )`

步骤 | 数栈 | 操作栈
---|---|---
1|1|
2|1|+
3|1,2|+
4|1,2|+,*
5|1,2,(|+,*
6|1,2,(,3|+,*
7|1,2,(,3|+,*+
8|1,2,(,3,4|+,*+
9|1,2,(,3,4|+,\*,+,\*
10|1,2,(,3,4,5|+,\*,+,\*
11|1,2,(,3,20|+,\*,+
12|1,2,23|+,\*
13|1,46|+
14|47|
